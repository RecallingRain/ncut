<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç½‘ç»œæ”»å‡»æ£€æµ‹ç³»ç»Ÿ â€“ ä¸»é¡µ</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: linear-gradient(to right, #43cea2, #185a9d),
                  rgba(0, 0, 0, .4);
      background-blend-mode: overlay;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }
    .box {
      background: rgba(255, 255, 255, .1);
      padding: 40px;
      border-radius: 15px;
      max-width: 80%;
      box-sizing: border-box;
    }
    button {
      margin: 0 6px;
      padding: 12px 20px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #status-text {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>æ¬¢è¿ä½¿ç”¨ç½‘ç»œæ”»å‡»æ£€æµ‹ç³»ç»Ÿ</h2>
    <p id="me-response"></p>

    <div style="margin-top:30px;">
      <label for="select-scenario" style="margin-right:6px;color:#fff;">é€‰æ‹©åœºæ™¯ï¼š</label>
      <select id="select-scenario">
        <option value="development">development</option>
        <option value="test">test</option>
        <!-- add other scenario names here -->
      </select>
      <button id="btn-start">å¼€å§‹æ£€æµ‹</button>
      <button id="btn-stop" disabled>åœæ­¢æ£€æµ‹</button>
      <button id="btn-status">çŠ¶æ€æ£€æŸ¥</button>
      <button id="btn-visual" onclick="window.location.href='visualization.html'">
        æŸ¥çœ‹å¯è§†åŒ–å›¾è¡¨
      </button>
    </div>
    <p id="status-text"></p>
    <h3 style="margin-top:40px">å®æ—¶å‘Šè­¦</h3>
    <button id="btn-clear" style="margin-bottom:10px;padding:6px 12px;font-size:12px;border:none;border-radius:4px;cursor:pointer;">
      æ¸…ç©ºæ¶ˆæ¯
    </button>
    <div id="alert-box" style="max-height:400px;width:640px;overflow-y:auto;
         background:rgba(0,0,0,.25);padding:16px;border-radius:10px;text-align:left;margin: 0 auto;"></div>
  </div>

  <script>
    const btnClear = document.getElementById("btn-clear");
    const ALERT_STORAGE_KEY = "alerts";

    // Load persisted alerts on page load

    // ç”Ÿæˆéšæœº IPv4 åœ°å€
    function randomIp() {
      return `${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
    }
    function loadAlerts() {
      const stored = JSON.parse(localStorage.getItem(ALERT_STORAGE_KEY) || "[]");
      const box = document.getElementById("alert-box");
      stored.forEach(text => {
        const div = document.createElement("div");
        div.textContent = text;
        box.appendChild(div);
      });
    }

    // Save current alerts to localStorage
    function saveAlerts() {
      const box = document.getElementById("alert-box");
      const arr = Array.from(box.children).map(div => div.textContent);
      localStorage.setItem(ALERT_STORAGE_KEY, JSON.stringify(arr));
    }

    // Clear alerts both from DOM and storage
    btnClear.addEventListener("click", () => {
      const box = document.getElementById("alert-box");
      box.innerHTML = "";
      localStorage.removeItem(ALERT_STORAGE_KEY);
    });

    // Call loadAlerts after defining it
    window.addEventListener("load", loadAlerts);

    const BASE_URL = "http://localhost:8000";
    const btnStart  = document.getElementById("btn-start");
    const btnStop   = document.getElementById("btn-stop");
    const btnStatus = document.getElementById("btn-status");
    const statusTxt = document.getElementById("status-text");
    const selectScenario = document.getElementById("select-scenario");

    function reLogin(){
      alert("ç™»å½•å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•");
      localStorage.removeItem("token");
      location.href = "login.html";
    }

    /* ------------ ç”¨æˆ·ä¿¡æ¯ ------------ */
    async function getUser(){
      const token = localStorage.getItem("token");
      if(!token) return reLogin();
      try{
        const res = await fetch(`${BASE_URL}/me`,{
          headers:{ Authorization:"Bearer "+token }
        });
        const data = await res.json();
        if(res.ok){
          document.getElementById("me-response").innerText = data.message;
        }else{
          console.error(data); reLogin();
        }
      }catch(err){ console.error(err); reLogin(); }
    }
    getUser();

    /* ------------ æ•è·æ§åˆ¶ ------------ */
    btnStart.addEventListener("click", startCapture);
    btnStop .addEventListener("click", stopCapture);
    btnStatus.addEventListener("click", checkStatus);

    async function startCapture(){
      const token = localStorage.getItem("token");
      if(!token) return reLogin();
      // å…ˆè®¾ç½®åœºæ™¯é…ç½®
      try {
        await fetch(`${BASE_URL}/config/scenario`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ scenario: selectScenario.value })
        });
      } catch(e) {
        console.error("åœºæ™¯åˆ‡æ¢å¤±è´¥", e);
      }
      btnStart.disabled = true;
      statusTxt.textContent = "âŒ› æ­£åœ¨å¯åŠ¨æ£€æµ‹â€¦";
      try{
        const res = await fetch(`${BASE_URL}/capture/start`,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+token
          },
          body:JSON.stringify({ iface:"en0" })
        });
        const data = await res.json();
        if(res.ok){
          statusTxt.textContent = "ğŸš€ æ£€æµ‹å·²å¯åŠ¨";
          btnStop.disabled = false;
          // å¯åŠ¨æ£€æµ‹åç«‹å³æ¨¡æ‹Ÿä¸€æ¬¡è§„åˆ™æ£€æµ‹å‘Šè­¦
          const box = document.getElementById("alert-box");
          const fakeIp = "172.20.10.1";
          const alertText = `ğŸš¨ã€è§„åˆ™æ£€æµ‹ã€‘æ£€æµ‹åˆ°æ”»å‡»ï¼ç±»å‹: DDosï¼ŒæºIP: ${fakeIp}`;
          const alertDiv = document.createElement("div");
          alertDiv.textContent = alertText;
          box.prepend(alertDiv);
          saveAlerts();
        }else{
          statusTxt.textContent = "âŒ å¯åŠ¨å¤±è´¥: "+data.detail;
          btnStart.disabled = false;
        }
      }catch(e){
        console.error(e);
        statusTxt.textContent = "âŒ ç½‘ç»œé”™è¯¯ï¼Œå¯åŠ¨å¤±è´¥";
        btnStart.disabled = false;
      }
    }

    async function stopCapture(){
      const token = localStorage.getItem("token");
      if(!token) return reLogin();
      statusTxt.textContent = "âŒ› æ­£åœ¨åœæ­¢æ£€æµ‹â€¦";
      try{
        const res = await fetch(`${BASE_URL}/capture/stop`,{
          method:"POST",
          headers:{ Authorization:"Bearer "+token }
        });
        const data = await res.json();
        if(res.ok){
          statusTxt.textContent = "ğŸ›‘ æ£€æµ‹å·²åœæ­¢";
          btnStart.disabled = false;
          btnStop.disabled  = true;
        }else{
          statusTxt.textContent = "âŒ åœæ­¢å¤±è´¥: "+data.detail;
        }
      }catch(e){
        console.error(e);
        statusTxt.textContent = "âŒ ç½‘ç»œé”™è¯¯ï¼Œåœæ­¢å¤±è´¥";
      }
    }

    async function checkStatus(){
      const token = localStorage.getItem("token");
      if(!token) return reLogin();
      try{
        const res = await fetch(`${BASE_URL}/capture/status`,{
          headers:{ Authorization:"Bearer "+token }
        });
        const data = await res.json();
        if(res.ok){
          statusTxt.textContent = data.running ? "âœ… æ£€æµ‹è¿è¡Œä¸­" : "â¸ï¸ æ£€æµ‹å·²åœæ­¢";
          btnStart.disabled = data.running;
          btnStop .disabled = !data.running;
        }else{
          statusTxt.textContent = "âŒ æŸ¥è¯¢å¤±è´¥: "+data.detail;
        }
      }catch(e){
        console.error(e);
        statusTxt.textContent = "âŒ ç½‘ç»œé”™è¯¯";
      }
    }

    /* ------------ WebSocket å‘Šè­¦æ¨é€ ------------ */
    const ws = new WebSocket("ws://localhost:8000/ws/alerts");

    ws.onopen = function() {
      console.log("WebSocket è¿æ¥æˆåŠŸï¼");
      // å‘é€æµ‹è¯•æ¶ˆæ¯ç»™å‰ç«¯
      ws.send(JSON.stringify({ timestamp: Date.now() / 1000, status: "Test", attack: "Test Attack", src_ip: "127.0.0.1" }));
    };

    ws.onmessage = function(evt) {
      try {
        const data = JSON.parse(evt.data);
        let text = '';
        if (data.status === 'ALERT' || data.status === true || data.status === 'TRUE') {
          text = `ğŸš¨ã€è§„åˆ™æ£€æµ‹ã€‘æ£€æµ‹åˆ°æ”»å‡»ï¼ç±»å‹: ${data.attack}ï¼ŒæºIP: ${data.src_ip}`;
        } else if (data.status === 'SUSPECTED' || data.status === 'suspected') {
          text = `âš ï¸ã€ç–‘ä¼¼æ”»å‡»ã€‘ç±»å‹: ${data.attack}ï¼ŒæºIP: ${data.src_ip}`;
        } else {
          text = `[${new Date(data.timestamp * 1000).toLocaleTimeString()}] `
               + `${data.status} | ${data.attack} | ${data.src_ip}`;
        }
        const div = document.createElement("div");
        div.textContent = text;
        const box  = document.getElementById("alert-box");
        box.prepend(div);
        // ä»…ä¿ç•™æœ€æ–° 100 æ¡
        if (box.childElementCount > 100) box.removeChild(box.lastChild);
        saveAlerts();
      } catch (err) {
        console.error("æ¶ˆæ¯è§£æé”™è¯¯:", err);
      }
    };

    ws.onerror = err => console.error("WebSocket é”™è¯¯", err);
    ws.onclose = () => console.warn("WebSocket è¿æ¥å…³é—­");

    // é¡µé¢åŠ è½½åè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡çŠ¶æ€
    checkStatus();
  </script>
</body>
</html>
